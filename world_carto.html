<!doctype HTML>
<meta charset = 'utf-8'>
<html>
  <head>
    <link rel='stylesheet' href='css/mapstyle.css'>
    
    <script src='js/d3.v3.min.js' type='text/javascript'></script>
    <script src='js/topojson.v1.min.js' type='text/javascript'></script>
    <script src='js/colorbrewer.js' type='text/javascript'></script>
    <script src='js/cartogram.mod.js' type='text/javascript'></script>
    
    <style>
    .rChart {
      display: block;
      margin-left: auto; 
      margin-right: auto;
      width: 800px;
      height: 400px;
    }  
    </style>
    
  </head>
  <body >
    
    
        <div id = 'chart2f0058e52cf' class = 'carto' style='height:100%;width:100%;'>
          <h1>Cartogram of the world's languages</h1>
          <form>
            <p>
              <label>Scale by <select id='field'></select></label>
              <span id='status'></span><br>
            </p>
          </form>
          <div id='map-container'>
            <!--img id='placeholder' alt='placeholder image for old browsers' src='placeholder.png'-->
            <svg id = 'map' style = 'height:100%; width:100%' viewbox = '0 0 800 400'>
          </svg>
          </div>
        </div>    
    
    <script>

      // hide the form if the browser doesn't do SVG,
      // (then just let everything else fail)
      if (!document.createElementNS) {
        document.getElementsByTagName("form")[0].style.display = "none";
      }
      
      
      // options/parameters from rCharts
      var opts = {
 "dom": "chart2f0058e52cf",
"width":    800,
"height":    400,
"map": "worldcountries.topojson",
"data": {
 "NAME": [ "-99", "AE", "AF", "AG", "AL", "AM", "AO", "AQ", "AR", "AT", "AU", "AZ", "BA", "BB", "BD", "BE", "BF", "BG", "BH", "BI", "BJ", "BN", "BO", "BR", "BS", "BT", "BW", "BY", "BZ", "CA", "CD", "CF", "CG", "CH", "CI", "CK", "CL", "CM", "CN", "CO", "CR", "CU", "CV", "CW", "CY", "CZ", "DE", "DJ", "DK", "DM", "DO", "DZ", "EC", "EE", "EG", "EH", "ER", "ES", "ET", "FI", "FJ", "FK", "FM", "FR", "GA", "GB", "GE", "GF", "GH", "GL", "GM", "GN", "GP", "GQ", "GR", "GT", "GU", "GW", "GY", "HK", "HN", "HR", "HT", "HU", "ID", "IE", "IL", "IM", "IN", "IQ", "IR", "IS", "IT", "JM", "JO", "JP", "KE", "KG", "KH", "KI", "KM", "KP", "KR", "KW", "KZ", "LA", "LB", "LC", "LK", "LR", "LS", "LT", "LU", "LV", "LY", "MA", "MD", "ME", "MG", "MH", "MK", "ML", "MM", "MN", "MP", "MR", "MT", "MU", "MV", "MW", "MX", "MY", "MZ", "NA", "NC", "NE", "NF", "NG", "NI", "NL", "NO", "NP", "NR", "NU", "NZ", "OM", "PA", "PE", "PF", "PG", "PH", "PK", "PL", "PR", "PS", "PT", "PW", "PY", "QA", "RE", "RO", "RS", "RU", "RW", "SA", "SB", "SC", "SD", "SE", "SG", "SI", "SK", "SL", "SN", "SO", "SR", "SS", "ST", "SV", "SY", "SZ", "TC", "TD", "TF", "TG", "TH", "TJ", "TK", "TL", "TM", "TN", "TO", "TR", "TT", "TV", "TW", "TZ", "UA", "UG", "US", "UY", "UZ", "VA", "VC", "VE", "VI", "VN", "VU", "WF", "WS", "XK", "YE", "YT", "ZA", "ZM", "ZW" ],
"NRLANGUAGES2010": [ 0, 1, 30, 1, 1, 3, 23, 0, 15, 2, 268, 8, 1, 1, 14, 4, 52, 2, 1, 1, 40, 5, 37, 201, 2, 20, 16, 1, 2, 76, 183, 56, 38, 6, 66, 4, 9, 242, 187, 82, 6, 2, 1, 1, 1, 4, 18, 0, 4, 1, 1, 13, 18, 2, 6, 0, 5, 14, 80, 7, 8, 0, 17, 18, 27, 13, 8, 3, 64, 1, 1, 27, 1, 9, 10, 51, 1, 12, 8, 1, 5, 5, 2, 2, 719, 3, 22, 1, 368, 12, 56, 2, 19, 2, 2, 14, 47, 2, 14, 1, 4, 0, 2, 0, 1, 50, 0, 1, 5, 25, 1, 3, 1, 3, 6, 7, 2, 0, 11, 1, 1, 32, 85, 4, 2, 3, 2, 1, 1, 8, 287, 110, 30, 16, 36, 10, 1, 486, 8, 12, 6, 105, 2, 1, 2, 7, 7, 100, 7, 826, 169, 57, 6, 1, 2, 3, 3, 15, 0, 1, 3, 5, 91, 1, 4, 71, 1, 63, 11, 2, 1, 2, 12, 25, 8, 11, 53, 3, 3, 3, 1, 1, 110, 0, 19, 33, 5, 1, 17, 2, 4, 3, 11, 2, 1, 22, 110, 5, 34, 210, 1, 5, 2, 1, 27, 2, 79, 108, 2, 1, 1, 6, 1, 19, 26, 7 ],
"FULLNAME": [ "Null", "United Arab Emirates", "Afghanistan", "Antigua and Barbuda", "Albania", "Armenia", "Angola", "Antarctica", "Argentina", "Austria", "Australia", "Azerbaijan", "Bosnia and Herzegovina", "Barbados", "Bangladesh", "Belgium", "Burkina Faso", "Bulgaria", "Bahrain", "Burundi", "Benin", "Brunei", "Bolivia", "Brazil", "Bahamas", "Bhutan", "Botswana", "Belarus", "Belize", "Canada", "Democratic Republic of the Congo", "Central African Republic", "Republic of the Congo", "Switzerland", "Ivory Coast", "Cook Islands", "Chile", "Cameroon", "China", "Colombia", "Costa Rica", "Cuba", "Cape Verde", "Curacao", "Cyprus", "Czechia", "Germany", "Djibouti", "Denmark", "Dominica", "Dominican Republic", "Algeria", "Ecuador", "Estonia", "Egypt", "Western Sahara", "Eritrea", "Spain", "Ethiopia", "Finland", "Fiji", "Falkland Islands", "Micronesia", "France", "Gabon", "United Kingdom", "Georgia", "French Guiana", "Ghana", "Greenland", "Gambia", "Guinea", "Guadeloupe", "Equatorial Guinea", "Greece", "Guatemala", "Guam", "Guinea-Bissau", "Guyana", "Hong Kong", "Honduras", "Croatia", "Haiti", "Hungary", "Indonesia", "Ireland", "Israel", "Isle of Man", "India", "Iraq", "Iran", "Iceland", "Italy", "Jamaica", "Jordan", "Japan", "Kenya", "Kyrgyzstan", "Cambodia", "Kiribati", "Comoros", "North Korea", "South Korea", "Kuwait", "Kazakhstan", "Laos", "Lebanon", "Saint Lucia", "Sri Lanka", "Liberia", "Lesotho", "Lithuania", "Luxembourg", "Latvia", "Libya", "Morocco", "Moldova", "Montenegro", "Madagascar", "Marshall Islands", "Macedonia", "Mali", "Myanmar [Burma]", "Mongolia", "Northern Mariana Islands", "Mauritania", "Malta", "Mauritius", "Maldives", "Malawi", "Mexico", "Malaysia", "Mozambique", "Namibia", "New Caledonia", "Niger", "Norfolk Island", "Nigeria", "Nicaragua", "Netherlands", "Norway", "Nepal", "Nauru", "Niue", "New Zealand", "Oman", "Panama", "Peru", "French Polynesia", "Papua New Guinea", "Philippines", "Pakistan", "Poland", "Puerto Rico", "Palestine", "Portugal", "Palau", "Paraguay", "Qatar", "Réunion", "Romania", "Serbia", "Russia", "Rwanda", "Saudi Arabia", "Solomon Islands", "Seychelles", "Sudan", "Sweden", "Singapore", "Slovenia", "Slovakia", "Sierra Leone", "Senegal", "Somalia", "Suriname", "South Sudan", "São Tomé and Príncipe", "El Salvador", "Syria", "Swaziland", "Turks and Caicos Islands", "Chad", "French Southern Territories", "Togo", "Thailand", "Tajikistan", "Tokelau", "East Timor", "Turkmenistan", "Tunisia", "Tonga", "Turkey", "Trinidad and Tobago", "Tuvalu", "Taiwan", "Tanzania", "Ukraine", "Uganda", "United States", "Uruguay", "Uzbekistan", "Vatican City", "Saint Vincent and the Grenadines", "Venezuela", "U.S. Virgin Islands", "Vietnam", "Vanuatu", "Wallis and Futuna", "Samoa", "Kosovo", "Yemen", "Mayotte", "South Africa", "Zambia", "Zimbabwe" ],
"POPULATION2010": [ 0, 8442, 28398, 87, 3150, 2963, 19549, 0, 40374, 8402, 22404, 9095, 3846, 280, 151125, 10941, 15540, 7389, 1252, 9233, 9510, 401, 10157, 195210, 360, 717, 1969, 9491, 309, 34126, 62191, 4350, 4112, 7831, 18977, 20, 17151, 20624, 1359821, 46445, 4670, 11282, 488, 148, 1104, 10554, 83017, 834, 5551, 71, 10017, 37063, 15001, 1299, 78076, 515, 5741, 46182, 87095, 5368, 861, 3, 104, 63231, 1556, 62066, 4389, 231, 24263, 57, 1681, 10876, 459, 696, 11110, 14342, 159, 1587, 786, 7050, 7621, 4338, 9896, 10015, 240676, 4468, 7420, 84, 1205625, 30962, 74462, 318, 60509, 2741, 6455, 127353, 40909, 5334, 14365, 98, 683, 24501, 48454, 2992, 15921, 6396, 4341, 177, 20759, 3958, 2009, 3068, 508, 2091, 6041, 31642, 3573, 620, 21080, 52, 2102, 13986, 51931, 2713, 54, 3609, 425, 1231, 326, 15014, 117886, 28276, 23967, 2179, 246, 15894, 0, 159708, 5822, 16615, 4891, 26846, 10, 1, 4368, 2803, 3678, 29263, 268, 6859, 93444, 173149, 38199, 3710, 4013, 10590, 20, 6460, 1750, 845, 21861, 9647, 143618, 10837, 27258, 526, 91, 35652, 9382, 5079, 2054, 5433, 5752, 12951, 9636, 525, 9941, 178, 6218, 21533, 1193, 31, 11721, 0, 6306, 66402, 7627, 1, 1079, 5042, 10632, 104, 72138, 1328, 10, 23146, 44973, 46050, 33987, 312247, 3372, 27769, 1, 109, 29043, 106, 89047, 236, 14, 186, 0, 22763, 204, 51452, 13217, 13077 ],
"country": [ null, "United Arab Emirates", "Afghanistan", "Antigua and Barbuda", "Albania", "Armenia", "Angola", null, "Argentina", "Austria", "Australia", "Azerbaijan", "Bosnia and Herzegovina", "Barbados", "Bangladesh", "Belgium", "Burkina Faso", "Bulgaria", "Bahrain", "Burundi", "Benin", "Brunei Darussalam", "Bolivia", "Brazil", "Bahamas, The", "Bhutan", "Botswana", "Belarus", "Belize", "Canada", "Congo, Dem. Rep.", "Central African Republic", "Congo, Rep.", "Switzerland", "Cote d'Ivoire", null, "Chile", "Cameroon", "China", "Colombia", "Costa Rica", "Cuba", "Cabo Verde", "Curacao", "Cyprus", "Czech Republic", "Germany", "Djibouti", "Denmark", "Dominica", "Dominican Republic", "Algeria", "Ecuador", "Estonia", "Egypt, Arab Rep.", null, "Eritrea", "Spain", "Ethiopia", "Finland", "Fiji", null, "Micronesia, Fed. Sts.", "France", "Gabon", "United Kingdom", "Georgia", null, "Ghana", "Greenland", "Gambia, The", "Guinea", null, "Equatorial Guinea", "Greece", "Guatemala", "Guam", "Guinea-Bissau", "Guyana", "Hong Kong SAR, China", "Honduras", "Croatia", "Haiti", "Hungary", "Indonesia", "Ireland", "Israel", "Isle of Man", "India", "Iraq", "Iran, Islamic Rep.", "Iceland", "Italy", "Jamaica", "Jordan", "Japan", "Kenya", "Kyrgyz Republic", "Cambodia", "Kiribati", "Comoros", "Korea, Dem. Rep.", "Korea, Rep.", "Kuwait", "Kazakhstan", "Lao PDR", "Lebanon", "St. Lucia", "Sri Lanka", "Liberia", "Lesotho", "Lithuania", "Luxembourg", "Latvia", "Libya", "Morocco", "Moldova", "Montenegro", "Madagascar", "Marshall Islands", "Macedonia, FYR", "Mali", "Myanmar", "Mongolia", "Northern Mariana Islands", "Mauritania", "Malta", "Mauritius", "Maldives", "Malawi", "Mexico", "Malaysia", "Mozambique", "Namibia", "New Caledonia", "Niger", null, "Nigeria", "Nicaragua", "Netherlands", "Norway", "Nepal", null, null, "New Zealand", "Oman", "Panama", "Peru", "French Polynesia", "Papua New Guinea", "Philippines", "Pakistan", "Poland", "Puerto Rico", "West Bank and Gaza", "Portugal", "Palau", "Paraguay", "Qatar", null, "Romania", "Serbia", "Russian Federation", "Rwanda", "Saudi Arabia", "Solomon Islands", "Seychelles", "Sudan", "Sweden", "Singapore", "Slovenia", "Slovak Republic", "Sierra Leone", "Senegal", "Somalia", "Suriname", "South Sudan", "Sao Tome and Principe", "El Salvador", "Syrian Arab Republic", "Swaziland", "Turks and Caicos Islands", "Chad", null, "Togo", "Thailand", "Tajikistan", null, "Timor-Leste", "Turkmenistan", "Tunisia", "Tonga", "Turkey", "Trinidad and Tobago", "Tuvalu", null, "Tanzania", "Ukraine", "Uganda", "United States", "Uruguay", "Uzbekistan", null, "St. Vincent and the Grenadines", "Venezuela, RB", "Virgin Islands (U.S.)", "Vietnam", "Vanuatu", null, "Samoa", null, "Yemen, Rep.", null, "South Africa", "Zambia", "Zimbabwe" ],
"NY.GDP.MKTP.KD": [      0,      0, 1.2965e+10, 1.0314e+09, 1.1336e+10, 6.875e+09, 5.7296e+10,      0, 3.3134e+11, 3.3902e+11, 8.6724e+11, 3.0631e+10, 1.2926e+10,      0, 9.7926e+10, 4.0762e+11, 8.6404e+09, 3.4091e+10, 2.3307e+10, 1.5758e+09, 6.0276e+09, 1.0104e+10, 1.4119e+10, 1.1667e+12,      0, 1.5359e+09, 1.4205e+10, 4.6534e+10, 1.3555e+09, 1.3191e+12, 1.946e+10, 1.3045e+09, 8.7199e+09, 4.4841e+11, 2.0609e+10,      0, 1.7141e+11, 2.2068e+10, 4.864e+12, 2.1147e+11, 2.845e+10,      0, 1.3661e+09,      0,      0, 1.4822e+11, 3.0871e+12, 1.0323e+09, 2.5966e+11, 4.4466e+08, 5.4048e+10, 1.2707e+11, 5.749e+10, 1.5953e+10, 1.2854e+11,      0, 1.2453e+09, 1.1463e+12, 2.7218e+10, 2.0494e+11, 3.2431e+09,      0, 2.542e+08, 2.2542e+12, 1.1598e+10, 2.4328e+12, 9.6564e+09,      0, 1.9844e+10,      0, 8.4099e+08, 3.6175e+09,      0, 8.3199e+09, 2.002e+11, 3.6208e+10,      0, 6.8168e+08, 1.0696e+09, 2.4103e+11, 1.2771e+10, 4.446e+10, 4.8832e+09,      0, 4.5233e+11, 2.0734e+11, 1.8871e+11,      0, 1.4587e+12, 8.3724e+10, 2.4255e+11, 1.7626e+10, 1.6978e+12,      0, 1.8441e+10, 4.7667e+12, 2.6887e+10, 3.5757e+09, 1.0734e+10, 1.2039e+08, 4.5011e+08,      0, 1.1999e+12,      0, 9.2422e+10, 5.0843e+09, 3.2347e+10, 1.0791e+09, 4.1053e+10, 1.2859e+09, 2.0294e+09,      0, 4.2283e+10,      0, 3.8629e+10, 8.5019e+10, 4.0438e+09, 2.9208e+09, 6.0808e+09, 1.5438e+08, 7.5379e+09, 7.2861e+09,      0, 5.0976e+09,      0, 3.3413e+09,      0, 8.6583e+09, 1.6996e+09, 3.6719e+09, 1.0421e+12, 2.0773e+11, 1.1257e+10, 1.0553e+10,      0, 5.1608e+09,      0, 1.9062e+11, 8.312e+09, 6.7531e+11, 3.3143e+11, 1.137e+10,      0,      0, 1.2894e+11, 4.8337e+10, 2.9909e+10, 1.2352e+11,      0, 8.131e+09, 1.5556e+11, 1.4688e+11, 4.1431e+11,      0,      0, 1.8584e+11, 1.9994e+08, 1.3045e+10, 1.2666e+11,      0, 1.2124e+11, 2.8567e+10, 9.9351e+11, 4.5653e+09, 5.1989e+11, 6.2456e+08, 1.2695e+09, 2.9273e+10, 4.2362e+11, 1.9922e+11,      0,      0, 3.1264e+09, 1.1389e+10,      0, 2.5005e+09,      0, 1.9061e+08, 1.9421e+10,      0, 3.036e+09,      0, 9.5117e+09,      0, 2.8928e+09, 2.3037e+11, 3.9449e+09,      0, 9.6165e+08, 1.8639e+10, 4.349e+10, 2.8034e+08, 6.5316e+11, 1.9273e+10, 2.6156e+07,      0, 2.401e+10, 9.7269e+10, 1.5586e+10, 1.4499e+13, 2.6604e+10, 2.7198e+10,      0, 6.1396e+08, 1.9465e+11,      0, 9.2277e+10, 5.3332e+08,      0, 4.4346e+08,      0, 1.8115e+10,      0, 3.1347e+11, 1.1944e+10, 6.2421e+09 ],
"year": [   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013,   2013 ] 
},
"x": "NY.GDP.MKTP.KD",
"id": "chart2f0058e52cf" 
};
      
      
      

      // field definitions from:
      // <http://www.census.gov/popest/data/national/totals/2011/files/NST-EST2011-alldata.pdf>
      var percent = (function() {
            var fmt = d3.format(".2f");
            return function(n) { return fmt(n) + "%"; };
          })(),
          fields = [
{name: "(no scale)", id: "none"},
// {name: "Census Population", id: "censuspop", key: "CENSUS%dPOP", years: [2010]},
// {name: "Estimate Base", id: "censuspop", key: "ESTIMATESBASE%d", years: [2010]},
{name: "Number of languages", id: "nrlangs", key: "NRLANGUAGES%d", unit: " languages"},
{name: "Population", id: "population", key: "POPULATION%d", unit: ",000"},
],
          years = [2010],
          fieldsById = d3.nest()
            .key(function(d) { return d.id; })
            .rollup(function(d) { return d[0]; })
            .map(fields),
          field = fields[0],
          year = years[0],
          colors = colorbrewer.RdYlBu[3]
            //.reverse()
            .map(function(rgb) { return d3.hsl(rgb); });

      var body = d3.select("body"),
          stat = d3.select("#status");

      var fieldSelect = d3.select("#field")
        .on("change", function(e) {
          field = fields[this.selectedIndex];
          location.hash = "#" + [field.id].join("/");
        });
     /*   
      var showLang = d3.select("#lgloc")
        .on("change",function(e){
            if(this.checked){
                d3.select("#languages").classed("nodisplay",false);
            }
            else{
                d3.select("#languages").classed("nodisplay",true);
            }
        });
      */
      fieldSelect.selectAll("option")
        .data(fields)
        .enter()
        .append("option")
          .attr("value", function(d) { return d.id; })
          .text(function(d) { return d.name; });

      var yearSelect = d3.select("#year")
        .on("change", function(e) {
          year = years[this.selectedIndex];
          //location.hash = "#" + [field.id, year].join("/");
          location.hash = "#" + field.id;
        });

      yearSelect.selectAll("option")
        .data(years)
        .enter()
        .append("option")
          .attr("value", function(y) { return y; })
          .text(function(y) { return y; })

      var map = d3.select("#map"),
          zoom = d3.behavior.zoom()
            .translate([0,0])
            .scale(.7)
            //.scaleExtent([0.5, 10.0])
            .on("zoom", updateZoom),
          layer = map.append("g")
            .attr("id", "layer"),
          worldcountries = layer.append("g")
            .attr("id", "worldcountries")
            .selectAll("path");
          layer2 = map.append("g")
            .attr("id","layer2"),
          languages = layer.append("g")
            .attr("id","languages")
            .selectAll("circle");

      // map.call(zoom);
      updateZoom();

      function updateZoom() {
        var scale = zoom.scale();
        layer.attr("transform",
          "translate(" + zoom.translate() + ") " +
          "scale(" + [scale, scale] + ")");
      }

      var proj = d3.geo.mercator(),
          topology,
          geometries,
          rawData,
          dataById = {},
          carto = d3.cartogram()
            .projection(proj)
            .properties(function(d) {
              return dataById[d.id];
            })
            .value(function(d) {
              return +d.properties[field];
            });

      window.onhashchange = function() {
        parseHash();
      };

      
      d3.json(opts.map, function(error, topo) {
        topology = topo;
        geometries = topology.objects.worldcountries;
        //geometries = features.properties.geometry;
        
        
        d3.csv("data/nrlangspop.csv", function(data) {
          rawData = data;
          //console.log(data);
          dataById = d3.nest()
            .key(function(d) { return d.NAME; })
            .rollup(function(d) {  return d[0]; })
            .map(data);
            
          
          init();
        
          
        });
      });

      function init() {
        var features = carto.features(topology, geometries).features,
            path = d3.geo.path()
              .projection(proj);
              //console.log(features);

       
        worldcountries = worldcountries.data(features)
          .enter()
          .append("path")
            .attr("class", "country")
            .attr("id", function(d) {
            //console.log(d)
              return d.properties.NAME;
              //return d.objects.worldcountries.geometries.id;
            })
            .attr("fill", "#fafafa")
            .attr("d", path)
            .attr("cursor","pointer");

        worldcountries.append("title");
        
        parseHash();
      }

      function reset() {
        stat.text("");
        body.classed("updating", false);
        
        //document.getElementById("lgloc").disabled = false;

        var features = carto.features(topology, geometries),
            path = d3.geo.path()
              .projection(proj);

        worldcountries.data(features)
          .transition()
            .duration(750)
            .ease("linear")
            .attr("fill", "#fafafa")
            .attr("d", path);

        worldcountries.select("title")
          .text(function(d) {
            return d.properties.FULLNAME;
          });
          
      }

      function update() {
        var start = Date.now();
        body.classed("updating", true);
        

        var key = field.key.replace("%d", year),
            fmt = (typeof field.format === "function")
              ? field.format
              : d3.format(field.format || ","),
            value = function(d) {
              return +d.properties[key];
            },
            values = worldcountries.data()
              .map(value)
              .filter(function(n) {
                return !isNaN(n);
              })
              .sort(d3.ascending),
            lo = values[0],
            hi = values[values.length - 1];

        var color = d3.scale.linear()
          .range(colors)
          .domain(lo < 0
            ? [lo, 0, hi]
            : [lo, d3.mean(values), hi]);

        // normalize the scale to positive numbers
        var scale = d3.scale.linear()
          .domain([lo, hi])
          .range([10, 1000]);

        // tell the cartogram to use the scaled values
        carto.value(function(d) {
          return scale(value(d));
        });

        // generate the new features, pre-projected
        var features = carto(topology, geometries).features;

        // update the data
        worldcountries.data(features)
          .select("title")
            .text(function(d) {
              return [d.properties.FULLNAME, fmt(value(d))].join(": ") + field.unit;
            });

        worldcountries.transition()
          .duration(2750)
          .ease("linear")
          .attr("fill", function(d) {
            return color(value(d));
          })
          .attr("d", carto.path);

        var delta = (Date.now() - start) / 1000;
        stat.text(["calculated in", delta.toFixed(1), "seconds"].join(" "));
        body.classed("updating", false);
      }
      
      

      var deferredUpdate = (function() {
        var timeout;
        return function() {
          var args = arguments;
          clearTimeout(timeout);
          stat.text("calculating...");
          return timeout = setTimeout(function() {
            update.apply(null, arguments);
          }, 10);
        };
      })();

      var hashish = d3.selectAll("a.hashish")
        .datum(function() {
          return this.href;
        });

      function parseHash() {
        var parts = location.hash.substr(1).split("/"),
            desiredFieldId = parts[0],
            desiredYear = +parts[1];

        field = fieldsById[desiredFieldId] || fields[0];
        year = (years.indexOf(desiredYear) > -1) ? desiredYear : years[0];

        fieldSelect.property("selectedIndex", fields.indexOf(field));

        if (field.id === "none") {

          yearSelect.attr("disabled", "disabled");
          reset();

        } else {

          if (field.years) {
            if (field.years.indexOf(year) === -1) {
              year = field.years[0];
            }
            yearSelect.selectAll("option")
              .attr("disabled", function(y) {
                return (field.years.indexOf(y) === -1) ? "disabled" : null;
              });
          } else {
            yearSelect.selectAll("option")
              .attr("disabled", null);
          }

          yearSelect
            .property("selectedIndex", years.indexOf(year))
            .attr("disabled", null);

          deferredUpdate();
          //location.replace("#" + [field.id, year].join("/"));
          location.replace("#" + field.id);

          hashish.attr("href", function(href) {
            return href + location.hash;
          });
        }
      }

    </script>
    
    <script></script>    
  </body>
</html>
